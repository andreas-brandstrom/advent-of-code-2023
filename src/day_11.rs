use nalgebra::DMatrix;

pub(crate) fn cosmic_expansion() {
    let data =
        "...#...................#.......................#.......................................................#....................................
        ........................................................#...................................................................................
        ...............................#..........#..........................#.....#......................#.........................................
        ......#.................................................................................#.............................#..............#......
        ...........................................................................................................................................#
        .................#........#.........................#...........#................#....................#......#..............................
        ........................................#................#....................................#..............................#..............
        ......................#.....................................................................................................................
        ..#.........#.......................#..............................#...............................................................#........
        .............................................................#..................................................#...........................
        ...................#...........#...................#....................#...............................................#...................
        ...........................................#...................................#.....................#......#...............................
        ....#.........................................................................................................................#.............
        ........................................................................................#..........................#........................
        ...........#........................#..........................#............#...............................................................
        .#...........................#..............................................................................................................
        ...............#..........................#................#.......................#.......................#................................
        .....................#...........................................................................................#..........................
        .........#.......................................#..................#..........#............#..........#..................#.................
        .......................................................................................................................................#....
        ....................................#........................#..........................#...................................................
        .....#.....................................#................................................................................................
        ...............#......................................#......................................................#....................#.........
        ....................#................................................................#.......#...............................#..............
        ...........#................................................................................................................................
        .........................#......................#...........................................................................................
        ...#..............................#....................................#...........................#........................................
        ..................................................................#..................................................................#......
        ..........................................#..........#......................#............................................#..................
        ...............#......................................................................#..........................#........................#.
        .....................#......................................................................................................................
        ..................................................#.............#.................................#.........................................
        #..........................#.........................................................................................#......................
        .....................................#......#................................#..............#...............#..................#............
        ........#............................................................................................#................................#.....
        ................................................................................................................#...........................
        ...............................#.......................#..................#................................................#................
        ..................................................................................................#...................#....................#
        ............................................................................................................................................
        ................#..........#....................#..................#..........................................#.............................
        ........#.................................#........................................#.....#.....................................#............
        .......................#............................................................................................#.......................
        .........................................................................................................................#.........#........
        ........................................................................................................#...................................
        ....#.......#...............#........................................#......................................................................
        ...........................................#.....#.............................................................#..............#.........#...
        ............................................................................................................................................
        .....................#................#..................#....................#..............#..............................................
        ......#.....................................................................................................................................
        ...............#......................................................................................#.........................#...........
        ........................#...........................#..........#......................................................#.....................
        .........................................#...........................#.................#......................#.............................
        ............................................................................................................................................
        ............................#.............................#.................................#..............................#...........#....
        .#...........#......................#.........#...........................#.................................................................
        ............................................................................................................................................
        .................#..................................................................#...........#.........#......................#..........
        ............................................................................................................................................
        ............................................................................................................................................
        .........#...................#.................................#.............#..............................................................
        ...............#....................................................#...............................................#.....#.................
        ..........................................#..............................................#...........#.......#..............................
        ..#..................................................................................................................................#......
        ..........................................................................#.........#.......................................................
        ....................................#.........................#.........................................................#...................
        ...............................#................................................................#...........................................
        ...........#.............................................#............................................#............#........................
        ...........................................................................................................................#............#...
        ................#...........................#......................#..........#.......#.....................................................
        #......................................................................................................................#............#.......
        ........................................................................#..................................#................................
        ..............................................................#...........................#.....#.........................................#.
        ......#.......#.....#.............#.........................................................................................................
        .............................#.........#..................#.................................................................................
        ..........#.........................................................................................................#.......................
        ......................................................#................................................#...................#................
        ....#....................#.........................................#.........................................#..............................
        ....................................#.........#...............#...............#..............#...................................#..........
        ............................................................................................................................................
        .............................#..................................................................................#.......#...................
        ........................................#................#...............#..................................................................
        ............................................................................................................................................
        .............................................................#.........................#................#...................................
        ..........#......#............................#..................................#...............#..............................#.........#.
        ..................................#.................................................................................#.......................
        ....................................................#.......................#...............#.................#.......................#.....
        .#...........#........................#..............................................#......................................................
        ................................................................#.......#..............................#....................................
        ..................................................................................................#...........................#.............
        ............................................................#............................................................#..............#...
        ......#.....................#......................................#...........#............................................................
        .....................................................#.............................................................#.............#..........
        .......................#.............#.....................................................................................................#
        ...........#.................................#............................#...........................#.....................................
        .#...............................#....................................................................................#.....................
        ...................#...................................#..........................................#..............#..........................
        .........................#.......................................#.............#............................................................
        ..........................................#.......#.....................#................#..................................#...............
        ...#.......................................................................................................#............................#...
        ............#.............................................#..................................#...................................#..........
        ............................#..........#.............................................................#.............#........................
        ......................#.....................................................................................................................
        .............................................................................................................#..............................
        ....#........................................#.....................................#.......................................#................
        .....................................................#..............#...................................................................#...
        #....................................#....................#.......................................................................#.........
        ................................................................................................#...........................................
        ...........#.........#....................#...............................#.............#................................#..................
        ............................................................................................................................................
        ......#..........................#...........................#...........................................#...........#......................
        .#.............#.........#.........................................#...........#.....#..................................................#...
        .....................................#...................#.....................................................................#............
        ...........................................................................................#................................................
        ...................#................................................................................#..............#........................
        ...........................................#......#........................................................................................#
        ..#........................#..................................#.........................#...................................................
        ........#.............................#...............................................................................#.....................
        ...............................#........................#...............#..............................#....................................
        .................................................................#..........................................#...............................
        ....................................................#........................#........#....................................#.........#......
        ....#.........#....................................................................................#.......................................#
        ......................#.....#.............................................................#.................................................
        #......................................#......#....................................#...............................#.............#..........
        .......................................................#..................................................#.................................
        .........................................................................#......................#...........................................
        ...............................................................................#............................................#...............
        ....#........#................#...............................#.......................................................................#.....
        .......................#.................................................................#..................#...............................
        .....................................#.............#........................................................................................
        ...................................................................................................#......................................#.
        ..#.........................................................................................................................................
        ........#.................................#.............#...........#................#......................................................
        ...............................................................................................#............................#...............
        .................#....................#.........................#..................................................................#........
        ....#.............................................#........................................................#........#.......................
        .........................#.............................................#............................#.......................................
        ......................................................#.................................#................................................#..
        .............................#...............#.................................#............................................................
        .........#....................................................................................#........................#........#...........
        ..................#...........................................#.................................................#...........................";

    let galaxy_map = parse_data(data);

    let expansion_coefficient = 1_000_000;
    let (expanded_rows, expanded_colums) = expand_space(&galaxy_map, expansion_coefficient);

    let mut galaxy_coordinats = get_galaxy_coordinates(&galaxy_map);

    for row in expanded_rows {
        for (x,_) in galaxy_coordinats.iter_mut() {
            if *x > row {
                *x += expansion_coefficient-1;
            }
        }
    }

    for col in expanded_colums {
        for(_,y) in galaxy_coordinats.iter_mut() {
            if *y >= col {
                *y += expansion_coefficient-1;
            }
        }
    }

    let mut sum = 0;
    while let Some(galaxy) = galaxy_coordinats.pop()  {
        for other_galaxy in &galaxy_coordinats {
            sum += (galaxy.0 as i64 - other_galaxy.0 as i64).abs() + (galaxy.1 as i64 - other_galaxy.1 as i64).abs(); 
        }
    }

    println!("Sum: {}", sum)
}

fn get_galaxy_coordinates(expanded_galaxy_map: &DMatrix<char>) -> Vec<(usize, usize)> {
    let mut galaxy_coordinats:Vec<(usize,usize)> = vec![];

    for (x, row) in expanded_galaxy_map.row_iter().enumerate() {
        for (y,element) in row.iter().enumerate() {
            if *element == '#' {
                galaxy_coordinats.push((x,y));
            }
        }
    }

    galaxy_coordinats
}

fn expand_space(galaxy_map: &DMatrix<char>, expansion_coefficient:usize) -> (Vec<usize>, Vec<usize>) {
    let mut number_of_expansions = 0;

    let  mut empty_rows:Vec<usize> = vec![];
    for (i,row) in galaxy_map.row_iter().enumerate() {
        if row.iter().filter(|&e| *e != '.').count() == 0 {
            empty_rows.push(i + number_of_expansions*(expansion_coefficient-1));
            number_of_expansions += 1;
        }
    }

    number_of_expansions = 0;

    let mut empty_colums:Vec<usize> = vec![]; 
    for (i,col) in galaxy_map.column_iter().enumerate() {
        if col.iter().filter(|&e| *e != '.').count() == 0 {
            empty_colums.push(i + (number_of_expansions*(expansion_coefficient-1)));
            number_of_expansions += 1;
        }
    }

    (empty_rows, empty_colums)
}

fn parse_data(data: &str) -> DMatrix<char> {
    let data = data.replace(' ', "");
    let size = (data.len() as f32).sqrt() as usize;

    let mut galaxy_map  = DMatrix::from_element(size, size, '.');

    for (i,line) in data.lines().enumerate() {
        for (j, char) in line.chars().enumerate() {
            galaxy_map[(i,j)] = char;
        };
    };

    galaxy_map
}
